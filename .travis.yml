dist: xenial
language: go

go:
- 1.13.x

services:
- docker

cache:
  directories:
    - $HOME/qemu
    - $HOME/packer

addons:
  apt:
    update: true
    packages:
    - kpartx
    - python-pip

before_install:
- sudo docker run --privileged linuxkit/binfmt:v0.6

before_script:
- "echo commit: $TRAVIS_COMMIT"
- "echo tag: $TRAVIS_TAG"
- "echo branch: $TRAVIS_BRANCH"
- "echo build: $TRAVIS_BUILD_NUMBER"
- bash bin/travis-qemu.sh
- bash bin/travis-packer.sh
- pip install --user ansible
- export PATH=$PATH:$HOME/qemu/bin:$HOME/packer/bin/

jobs:
  include:
    - stage: packer
      name: "enlarge raspbian disk image and activate ssh"
      script:
      - sudo ln -s $HOME/qemu/bin/qemu-arm /usr/local/bin/qemu-arm-static
      - wget -nv https://downloads.raspberrypi.org/raspbian_lite/images/raspbian_lite-2019-04-09/2019-04-08-raspbian-stretch-lite.zip
      - sudo env "PATH=$PATH" ~/packer/bin/packer build packer.json
      - ls -lh pimba.img
